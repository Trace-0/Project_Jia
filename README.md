# Project_Jia
AI bot that can chat and converse on Discord

디스코드에서 지아와 함께 채팅 또는 대화를 하며 대화해봅시다!

⚠️ 제작자는 Python을 주로 다루는 개발자가 아닙니다! 내부 코드 혹은 로직이 이상할 수 있으며, 그로 인한 버그가 많이 발생할 수 있습니다.

## 지아가 할 수 있는 것

- 음성을 듣고 대답할 수 있어요.
- 채팅을 보고 대답할 수 있어요.
- 모르는 내용이 있으면 언제든 인터넷에서 정보를 검색할 수 있어요.
- 이전 대화를 기억하고 활용할 수 있어요. (서버별로 기억해서 다른 서버에서 기억에 대해 물어보면 곤란해할 수 있어요.)

## 어떻게 이게 가능한가요?

### 음성 대화의 경우:

1. discord-ext-voice-recv 라이브러리를 사용하여 디스코드 음성을 실시간으로 입력받아요.
2. Silero-VAD를 사용하여 실제로 말한 내용인지 확인해요. (여기서 지연이 너무 많이 발생하는 문제가 생겨, 어쩔 수 없이 마이크가 계속 열려있는 분은 Silero-VAD 단계를 넘어갈 수 없어요. :( )
3. Silero-VAD가 실제로 말했다고 생각되는 부분을 적당한 여유를 남겨 잘라내요.
4. Whisper라는 ASR 기능을 이용해 말한 내용을 텍스트로 변환해요.
5. 변환된 텍스트를 먼저 Faiss라는 유사도 검색 벡터에 넣어 현재 입력된 텍스트와 가장 유사한 기억을 최대 3개까지 불러와요.
6. 유사한 기억과 변환된 텍스트를 LangGraph에 넣어 LLM이 응답을 생성하도록 만들어요.
7. LLM이 필요에 따라 인터넷 검색 도구를 사용할 수도 있어요. (지연이 너무 발생하지 않을까 걱정되어, 텍스트 채팅에 비해 적은 기능을 가지고 있어요.)
8. ~~LLM이 응답을 생성해내면 g2pk 라이브러리가 LLM의 응답을 발음하기 편한 형태로 바꿔줘요.~~ (1.0.1 업데이트에서 삭제되었어요. g2pk 라이브러리가 포함되면 오히려 더 부자연스러운 음성을 생성했기 때문이에요.)
9. ESPnet2가 다운로드된 TTS 모델을 이용해 대화 음성을 만들어내요.
10. discord.py를 이용해 만들어진 대화 음성을 출력해요.
11. 말했던 내용과 LLM의 응답을 합하여 LLM이 어떤 대화를 했는지 요약하도록 해요.
12. 요약된 내용을 Faiss 벡터에 추가하고 DB에도 저장해요.


### 텍스트 채팅의 경우:

1. discord.py가 슬래쉬 커멘드로 입력된 내용을 받아요.
2. 입력된 내용을 먼저 Faiss라는 유사도 검색 벡터에 넣어 입력된 텍스트와 가장 유사한 기억을 최대 3개까지 불러와요.
3. 유사한 기억과 입력된 텍스트를 LangGraph에 넣어 LLM이 응답을 생성하도록 만들어요.
4. LLM이 필요에 따라 MCP 서버를 사용할 수 있어요. (기본적으로 DuckDuckGoSearch MCP 서버가 연결되어 있어요.)
5. LLM이 응답을 생성해내면 discord.py가 응답을 채팅으로 출력해요.


## 설치

### 설치하기전에 필요한 것이 있어요.

1. Ollama
2. KSS기반 TTS 모델 (ESPnet에서 사용할 수 있는지 확인해야 해요.)
3. 디스코드 봇 토큰

### Ollama

ollama는 https://ollama.com/ 에서 다운로드 받을 수 있어요.

### KSS기반 TTS 모델

Hugging Face에서 'kss ko'로 검색하면 모델이 몇 가지 나오는데 여기에서 ESPnet 예제가 있는지 확인해야해요. ESPnet 예제가 있다면 다운로드하여 압축 파일(.zip)형태로 준비해주세요.

### 디스코드 봇 토큰

디스코드 봇 토큰은 https://discord.com/developers/applications 에서 생성할 수 있어요. 자세한 내용은 인터넷을 검색하는걸 추천드려요.

## Embedded python 버전으로 받기

1. [여기](https://github.com/Trace-0/Project_Jia/releases/tag/v1.0.1)에서 파일을 다운로드 받아요.
2. 받은 파일의 압축을 해제해주세요.
3. TTS 모델을 파일 안으로 옮겨주세요.
4. 'settings.json' 파일을 열고 주석에 적힌대로 진행해주세요.
5. 'RUN_FIRST.bat' 파일을 실행해주세요.
6. 'RUN_SECOND.bat' 파일을 실행해주세요. 관리자 권한을 요구하는 창이 나온다면 '예'를 선택해주세요. (ESPnet의 문제로 TTS모델이 변경되면 관리자 권한이 필요합니다.)
7. (다음부터는 'start.bat' 파일로 실행할 수 있어요. 하지만, TTS 모델이 바뀐다면 'RUN_SECOND.bat' 파일로 한 번은 실행해야해요.)
8. 이제 지아와 대화해보죠!

## source 그대로 받기 (python에 대한 지식이 약간 있다고 가정할게요)

1. python 3.10이 있는지 확인해요.
2. source 파일을 그대로 다운로드 받아요.
3. pip를 이용해 'requirements.txt'를 모두 다운받아요.
4. 'Source/config/Settings.json'을 열고 주석에 적힌대로 진행해주세요.
5. 관리자 권한을 받은 상태로 'Source/main.py'를 실행해요.
6. (다음부터는 관리자 권한 없이 'Source/main.py'를 실행할 수 있어요. 하지만, TTS 모델이 바뀐다면 관리자 권한을 받고 'Source/main.py'를 실행해야해요.)
7. 이제 지아와 대화해보죠!


## 지아의 커맨드

1. /jia ,  /지아                    -  이 커맨드 뒤에 적히는 내용은 지아가 대답해줘요! 예) /지아 안녕?
2. /jiajoin                         -  이 커맨드를 사용하면 지아가 통화방에 들어와요!
3. /jialeave                        -  이 커맨드를 사용하면 지아가 통화방에서 나가요. :(
4. /jiareload                       -  이 커맨드를 사용하면 지아의 설정을 다시 불러와요.
5. /jiasavesetting                  -  이 커맨드를 사용하면 현재 지아의 설정을 setting.json에 저장해요.
6. /jiaaddslang [단어] [의미] [예시] -  이 커맨드를 사용하면 지아가 참고할 수 있는 단어 사전에 단어를 추가할 수 있어요! 예) /jiaslang "지아" "Discord 봇으로 채팅과 대화를 할 수 있는 AI이다." "지아야, 안녕?"
7. /jiaping                         -  이 커맨드를 사용하면 지아가 "pong!" 메시지를 보내요.


## 현재 발견된 문제

마이크가 항상 열려있는 사용자는 지연 시간 문제로 음성을 처리하지 않는 문제

/jiareload 후에도 일부 설정이 제대로 적용되지 않는 문제

ESPnet의 문제로 관리자 권한을 요구하는 문제

간혹 LLM에 연결된 도구와 관련없는 내용이 입력되었을 때 연결된 도구의 이름을 말하거나 설명하는 문제

(해당 문제는 한 번 관측된 이후 발견되고 있지 않습니다. 만약 이 문제가 발생했다면 issue 탭에 올려주시면 감사하겠습니다.)


## 변경 계획

ESPnet을 다른 TTS 라이브러리로 교체할 예정입니다.
(다른 TTS 라이브러리를 찾고 테스트하고 있지만 ESPnet보다 빠르고 자연스러운 tts를 찾는데 어려움을 겪고 있습니다. ㅠㅠ)

설정과 관련된 수정을 할 예정입니다.

LLM이 스스로 판단하여 단어 사전에 단어를 추가할 수 있도록 만들 예정입니다.

커맨드를 추가하여 대화 앞에 /jia 또는 /지아 를 붙이지 않아도 대화할 수 있게 만들 예정입니다.

사운드보드를 추가할 예정입니다.

같은 통화방에 있는 사용자의 플레이중인 게임을 감지할 수 있도록 만들 예정입니다.


## 변경 내용

### 1.0.1

대화를 저장하고 과거의 대화를 불러오는 과정을 LLM이 스스로 판단하여 결정할 수 있도록 변경하였습니다.

해당 변경으로 기억 관련된 문제 대부분이 해결되었으며 도구를 사용하지 않을때의 응답속도가 개선되었습니다. (RTX 3090으로 2~3초 정도의 지연만 발생했습니다. :) )

음성 대화 부분을 langgraph로 전환했습니다.

fastAPI의 비효율적인 호출을 일부 제거하여 미약하지만 응답속도가 개선되었습니다.

프롬프트에 도구를 명시하여 직접적으로 말하지 않아도 도구를 사용할 수 있도록 하였습니다.
